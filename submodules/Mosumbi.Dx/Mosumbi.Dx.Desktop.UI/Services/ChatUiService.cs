using Avalonia.Controls;
using Mosumbi.Dx.Desktop.Shared.Abstractions;
using Mosumbi.Dx.Shared.Models;
using System.ComponentModel;
using Mosumbi.Dx.Desktop.UI.Controls.Dialogs;
using CommunityToolkit.Diagnostics;

namespace Mosumbi.Dx.Desktop.UI.Services;

public class ChatUiService : IChatUiService
{
    private readonly IUiDispatcher _dispatcher;
    private readonly IDialogProvider _dialogProvider;
    private readonly IViewModelFactory _viewModelFactory;
    private IChatWindowViewModel? _chatViewModel;

    public ChatUiService(
        IUiDispatcher dispatcher,
        IDialogProvider dialogProvider,
        IViewModelFactory viewModelFactory)
    {
        _dispatcher = dispatcher;
        _dialogProvider = dialogProvider;
        _viewModelFactory = viewModelFactory;
    }

    public event EventHandler? ChatWindowClosed;

    public async Task ReceiveChat(ChatMessage chatMessage)
    {
        await _dispatcher.InvokeAsync(async () =>
        {
            if (chatMessage.Disconnected)
            {
                await _dialogProvider.Show("Your partner has disconnected from the chat.", "Partner Disconnected", MessageBoxType.OK);
                Environment.Exit(0);
                return;
            }

            if (_chatViewModel != null)
            {
                _chatViewModel.SenderName = chatMessage.SenderName;
                _chatViewModel.ChatMessages.Add(chatMessage);
            }
        });
    }

    public void ShowChatWindow(string organizationName, StreamWriter writer)
    {
        _dispatcher.Post(() =>
        {
            _chatViewModel = _viewModelFactory.CreateChatWindowViewModel(organizationName, writer);
            var chatWindow = new ChatWindow()
            {
                DataContext = _chatViewModel
            };

            chatWindow.Closing += ChatWindow_Closing;
            _dispatcher.ShowMainWindow(chatWindow);
        });
    }

    private void ChatWindow_Closing(object? sender, CancelEventArgs e)
    {
        ChatWindowClosed?.Invoke(this, e);
    }
}
